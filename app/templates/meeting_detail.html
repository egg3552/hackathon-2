{% extends 'base.html' %}



{% block title %}{{ meeting.title }} - Meeting Details{% endblock %}



{% block content %}

<div class="row">

    <div class="col-md-12">

        <div class="card">

            <div class="card-header d-flex justify-content-between align-items-center">

                <h2>{{ meeting.title }}</h2>

                {% if meeting.created_by == user %}<div class="row"><div class="row" id="meetingDetailPage" data-meeting-id="{{ meeting_id }}">

                    <div>

                        <a href="{% url 'meeting_edit' meeting.pk %}" class="btn btn-warning btn-sm">Edit</a>    <div class="col-md-12">    <div class="col-12">

                        <a href="{% url 'meeting_delete' meeting.pk %}" class="btn btn-danger btn-sm">Delete</a>

                    </div>

                    <div class="card">
                        <a href="{% url 'index' %}" class="btn btn-outline-secondary mb-3">Back to Meetings</a>

                {% endif %}

            </div>
            <div class="card-header d-flex justify-content-between align-items-center">
                <i class="bi bi-arrow-left"></i>

            <div class="card-body">

                <p><strong>Date:</strong> {{ meeting.date|date:"F d, Y H:i" }}</p>                <h2>{{ meeting.title }}</h2>        </a>

                <p><strong>Location:</strong> {{ meeting.location|default:"Not specified" }}</p>

                <p><strong>Description:</strong> {{ meeting.description|default:"No description" }}</p>                {% if meeting.created_by == user %}        

                <p><strong>Created by:</strong> {{ meeting.created_by.username }}</p>

            </div>                    <div>        <!-- Meeting Header -->

        </div>

                        <a href="{% url 'meeting_edit' meeting.pk %}" class="btn btn-warning btn-sm">Edit</a>        <div id="meetingHeader" class="card mb-4">

        <div class="card mt-4">

            <div class="card-header d-flex justify-content-between align-items-center">                        <a href="{% url 'meeting_delete' meeting.pk %}" class="btn btn-danger btn-sm">Delete</a>            <div class="card-body">

                <h4>Attendees</h4>

                <a href="{% url 'attendee_add' meeting.pk %}" class="btn btn-primary btn-sm">Add Attendee</a>                    </div>                <div class="text-center py-3">

            </div>

            <div class="card-body">                {% endif %}                    <div class="spinner-border text-primary" role="status">

                {% if attendees %}

                    <ul class="list-group">            </div>                        <span class="visually-hidden">Loading...</span>

                        {% for attendee in attendees %}

                            <li class="list-group-item d-flex justify-content-between align-items-center">            <div class="card-body">                    </div>

                                <span>{{ attendee.user.username }} - <span class="badge bg-info">{{ attendee.get_status_display }}</span></span>

                                <a href="{% url 'attendee_remove' attendee.pk %}" class="btn btn-danger btn-sm">Remove</a>                <p><strong>Date:</strong> {{ meeting.date|date:"F d, Y H:i" }}</p>                </div>

                            </li>

                        {% endfor %}                <p><strong>Location:</strong> {{ meeting.location|default:"Not specified" }}</p>            </div>

                    </ul>

                {% else %}                <p><strong>Description:</strong> {{ meeting.description|default:"No description" }}</p>        </div>

                    <p>No attendees yet.</p>

                {% endif %}                <p><strong>Created by:</strong> {{ meeting.created_by.username }}</p>

            </div>

        </div>            </div>        <div class="row">



        <div class="card mt-4">        </div>            <!-- Notes Section -->

            <div class="card-header d-flex justify-content-between align-items-center">

                <h4>Notes</h4>            <div class="col-md-7">

                <a href="{% url 'note_create' meeting.pk %}" class="btn btn-primary btn-sm">Add Note</a>

            </div>        <!-- Attendees Section -->                <div class="card mb-4">

            <div class="card-body">

                {% if notes %}        <div class="card mt-4">                    <div class="card-header d-flex justify-content-between align-items-center">

                    {% for note in notes %}

                        <div class="card mb-3">            <div class="card-header d-flex justify-content-between align-items-center">                        <h5 class="mb-0"><i class="bi bi-journal-text"></i> Notes</h5>

                            <div class="card-body">

                                <p>{{ note.content }}</p>                <h4>Attendees</h4>                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createNoteModal">

                                <small class="text-muted">By {{ note.created_by.username }} on {{ note.created_at|date:"F d, Y H:i" }}</small>

                                {% if note.created_by == user %}                <a href="{% url 'attendee_add' meeting.pk %}" class="btn btn-primary btn-sm">Add Attendee</a>                            <i class="bi bi-plus-circle"></i> Add Note

                                    <div class="mt-2">

                                        <a href="{% url 'note_edit' note.pk %}" class="btn btn-warning btn-sm">Edit</a>            </div>                        </button>

                                        <a href="{% url 'note_delete' note.pk %}" class="btn btn-danger btn-sm">Delete</a>

                                    </div>            <div class="card-body">                    </div>

                                {% endif %}

                            </div>                {% if attendees %}                    <div class="card-body" id="notesList">

                        </div>

                    {% endfor %}                    <ul class="list-group">                        <div class="text-center py-3">

                {% else %}

                    <p>No notes yet.</p>                        {% for attendee in attendees %}                            <div class="spinner-border text-primary" role="status">

                {% endif %}

            </div>                            <li class="list-group-item d-flex justify-content-between align-items-center">                                <span class="visually-hidden">Loading...</span>

        </div>

                                <span>{{ attendee.user.username }} - <span class="badge bg-info">{{ attendee.get_status_display }}</span></span>                            </div>

        <div class="mt-3">

            <a href="{% url 'meeting_list' %}" class="btn btn-secondary">Back to Meetings</a>                                <a href="{% url 'attendee_remove' attendee.pk %}" class="btn btn-danger btn-sm">Remove</a>                        </div>

        </div>

    </div>                            </li>                    </div>

</div>

{% endblock %}                        {% endfor %}                </div>


                    </ul>            </div>

                {% else %}

                    <p>No attendees yet.</p>            <!-- Attendees Section -->

                {% endif %}            <div class="col-md-5">

            </div>                <div class="card">

        </div>                    <div class="card-header d-flex justify-content-between align-items-center">

                        <h5 class="mb-0"><i class="bi bi-people"></i> Attendees</h5>

        <!-- Notes Section -->                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createAttendeeModal">

        <div class="card mt-4">                            <i class="bi bi-person-plus"></i> Add

            <div class="card-header d-flex justify-content-between align-items-center">                        </button>

                <h4>Notes</h4>                    </div>

                <a href="{% url 'note_create' meeting.pk %}" class="btn btn-primary btn-sm">Add Note</a>                    <div class="card-body" id="attendeesList">

            </div>                        <div class="text-center py-3">

            <div class="card-body">                            <div class="spinner-border text-primary" role="status">

                {% if notes %}                                <span class="visually-hidden">Loading...</span>

                    {% for note in notes %}                            </div>

                        <div class="card mb-3">                        </div>

                            <div class="card-body">                    </div>

                                <p>{{ note.content }}</p>                </div>

                                <small class="text-muted">By {{ note.created_by.username }} on {{ note.created_at|date:"F d, Y H:i" }}</small>            </div>

                                {% if note.created_by == user %}        </div>

                                    <div class="mt-2">    </div>

                                        <a href="{% url 'note_edit' note.pk %}" class="btn btn-warning btn-sm">Edit</a></div>

                                        <a href="{% url 'note_delete' note.pk %}" class="btn btn-danger btn-sm">Delete</a>

                                    </div><!-- Create Note Modal -->

                                {% endif %}<div class="modal fade" id="createNoteModal" tabindex="-1">

                            </div>    <div class="modal-dialog modal-lg">

                        </div>        <div class="modal-content">

                    {% endfor %}            <div class="modal-header">

                {% else %}                <h5 class="modal-title">Add Note</h5>

                    <p>No notes yet.</p>                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

                {% endif %}            </div>

            </div>            <form id="createNoteForm">

        </div>                <div class="modal-body">

                    <div class="mb-3">

        <div class="mt-3">                        <label for="noteContent" class="form-label">Content (Markdown supported)</label>

            <a href="{% url 'meeting_list' %}" class="btn btn-secondary">Back to Meetings</a>                        <textarea class="form-control" id="noteContent" rows="10" required></textarea>

        </div>                        <small class="text-muted">You can use Markdown formatting</small>

    </div>                    </div>

</div>                </div>

{% endblock %}                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editNoteForm">
                <input type="hidden" id="editNoteId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editNoteContent" class="form-label">Content (Markdown supported)</label>
                        <textarea class="form-control" id="editNoteContent" rows="10" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Attendee Modal -->
<div class="modal fade" id="createAttendeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Attendee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createAttendeeForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="attendeeName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="attendeeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="attendeeEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="attendeeEmail" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Attendee</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Get meeting ID from data attribute
    const meetingId = parseInt(
        document.getElementById('meetingDetailPage').dataset.meetingId
    );

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadMeetingDetails();
        loadNotes();
        loadAttendees();
    });

    // Load meeting details
    async function loadMeetingDetails() {
        try {
            const response = await fetch(`/api/meetings/${meetingId}`);
            const meeting = await response.json();
            
            document.getElementById('meetingHeader').innerHTML = `
                <div class="card-body">
                    <h2 class="card-title">${meeting.title}</h2>
                    <p class="card-text">${meeting.description || 'No description'}</p>
                    <p class="mb-0">
                        <i class="bi bi-calendar3"></i> ${formatDate(meeting.date)}
                        ${meeting.location ? `<br><i class="bi bi-geo-alt"></i> ${meeting.location}` : ''}
                    </p>
                </div>
            `;
        } catch (error) {
            showFlashMessage('Failed to load meeting details', 'danger');
        }
    }

    // Load notes
    async function loadNotes() {
        try {
            const response = await fetch(`/api/notes?meeting_id=${meetingId}`);
            const data = await response.json();
            
            displayNotes(data.notes);
        } catch (error) {
            showFlashMessage('Failed to load notes', 'danger');
        }
    }

    // Display notes
    function displayNotes(notes) {
        const container = document.getElementById('notesList');
        
        if (notes.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No notes yet. Add your first note!</p>';
            return;
        }
        
        container.innerHTML = notes.map(note => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="markdown-content">${marked.parse(note.content)}</div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> ${formatDate(note.created_at)}
                        </small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editNote(${note.id}, \`${escapeHtml(note.content)}\`)">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteNote(${note.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Load attendees
    async function loadAttendees() {
        try {
            const response = await fetch(`/api/attendees?meeting_id=${meetingId}`);
            const data = await response.json();
            
            displayAttendees(data.attendees);
        } catch (error) {
            showFlashMessage('Failed to load attendees', 'danger');
        }
    }

    // Display attendees
    function displayAttendees(attendees) {
        const container = document.getElementById('attendeesList');
        
        if (attendees.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No attendees yet.</p>';
            return;
        }
        
        container.innerHTML = `
            <ul class="list-group list-group-flush">
                ${attendees.map(attendee => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${attendee.name}</strong><br>
                            <small class="text-muted">${attendee.email}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendee(${attendee.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </li>
                `).join('')}
            </ul>
        `;
    }

    // Create note form handler
    document.getElementById('createNoteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const noteData = {
            meeting_id: meetingId,
            content: document.getElementById('noteContent').value
        };
        
        try {
            const response = await fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(noteData)
            });
            
            if (response.ok) {
                showFlashMessage('Note added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('createNoteModal')).hide();
                document.getElementById('createNoteForm').reset();
                loadNotes();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to add note', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    });

    // Edit note
    function editNote(id, content) {
        document.getElementById('editNoteId').value = id;
        document.getElementById('editNoteContent').value = content;
        new bootstrap.Modal(document.getElementById('editNoteModal')).show();
    }

    // Edit note form handler
    document.getElementById('editNoteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('editNoteId').value;
        const noteData = {
            content: document.getElementById('editNoteContent').value
        };
        
        try {
            const response = await fetch(`/api/notes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(noteData)
            });
            
            if (response.ok) {
                showFlashMessage('Note updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editNoteModal')).hide();
                loadNotes();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to update note', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    });

    // Delete note
    async function deleteNote(id) {
        if (!confirm('Are you sure you want to delete this note?')) return;
        
        try {
            const response = await fetch(`/api/notes/${id}`, { method: 'DELETE' });
            
            if (response.ok) {
                showFlashMessage('Note deleted successfully!', 'success');
                loadNotes();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to delete note', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    }

    // Create attendee form handler
    document.getElementById('createAttendeeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const attendeeData = {
            meeting_id: meetingId,
            name: document.getElementById('attendeeName').value,
            email: document.getElementById('attendeeEmail').value
        };
        
        try {
            const response = await fetch('/api/attendees', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attendeeData)
            });
            
            if (response.ok) {
                showFlashMessage('Attendee added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('createAttendeeModal')).hide();
                document.getElementById('createAttendeeForm').reset();
                loadAttendees();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to add attendee', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    });

    // Delete attendee
    async function deleteAttendee(id) {
        if (!confirm('Are you sure you want to remove this attendee?')) return;
        
        try {
            const response = await fetch(`/api/attendees/${id}`, { method: 'DELETE' });
            
            if (response.ok) {
                showFlashMessage('Attendee removed successfully!', 'success');
                loadAttendees();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to remove attendee', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    }

    // Helper functions
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        return text.replace(/`/g, '\\`').replace(/\$/g, '\\$');
    }
</script>
{% endblock %}

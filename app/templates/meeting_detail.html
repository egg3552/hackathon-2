
{% extends 'base.html' %}

{% block title %}{{ meeting.title }} - Meeting Details{% endblock %}

{% block content %}

<div class="row">

    <div class="col-md-8">

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>{{ meeting.title }}</h3>
                <div>
                    {% if meeting.created_by == user %}
                        <a href="{% url 'meeting_edit' meeting.pk %}" class="btn btn-sm btn-warning">Edit</a>
                        <a href="{% url 'meeting_delete' meeting.pk %}" class="btn btn-sm btn-danger">Delete</a>
                    {% endif %}
                    <a href="{% url 'meeting_list' %}" class="btn btn-sm btn-outline-secondary">Back to Meetings</a>
                </div>
            </div>
            <div class="card-body">
                <p><strong>Date:</strong> {{ meeting.date|date:"F d, Y H:i" }}</p>
                <p><strong>Location:</strong> {{ meeting.location|default:"Not specified" }}</p>
                <p><strong>Description:</strong> {{ meeting.description|default:"No description" }}</p>
                <p><strong>Created by:</strong> {{ meeting.created_by.username }}</p>
                <p><strong>Visibility:</strong> {{ meeting.get_visibility_display }}</p>
                {% if meeting.last_edited_by %}
                    <p><strong>Last edited by:</strong> {{ meeting.last_edited_by.username }} on {{ meeting.updated_at|date:"F d, Y H:i" }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Notes Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Notes</h4>
                <a href="{% url 'note_create' meeting.pk %}" class="btn btn-sm btn-primary">Add Note</a>
            </div>
            <div class="card-body">
                {% if notes %}
                    {% for note in notes %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <p>{{ note.content }}</p>
                                <small class="text-muted">By {{ note.created_by.username }} on {{ note.created_at|date:"F d, Y H:i" }}</small>
                                <hr>
                                <!-- Comments -->
                                <div>
                                    {% for comment in note.comments.all %}
                                        <div class="mb-2">
                                            <p>{{ comment.content }}</p>
                                            <small class="text-muted">By {{ comment.created_by.username }} on {{ comment.created_at|date:"F d, Y H:i" }}</small>
                                            {% if comment.created_by == user %}
                                                <div>
                                                    <a href="{% url 'comment_edit' comment.pk %}" class="btn btn-sm btn-link">Edit</a>
                                                    <a href="{% url 'comment_delete' comment.pk %}" class="btn btn-sm btn-link text-danger">Delete</a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% empty %}
                                        <p class="text-muted">No comments.</p>
                                    {% endfor %}
                                </div>

                                <!-- Add comment form -->
                                {% if user.is_authenticated %}
                                    <form method="post" action="{% url 'comment_create' note.pk %}">
                                        {% csrf_token %}
                                        <div class="mb-2">
                                            <textarea name="content" class="form-control" rows="3" placeholder="Add a comment..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-sm btn-primary">Post Comment</button>
                                    </form>
                                {% else %}
                                    <p class="text-muted">Log in to post comments.</p>
                                {% endif %}
                                <div class="mt-2">
                                    {% if note.created_by == user %}
                                        <a href="{% url 'note_edit' note.pk %}" class="btn btn-sm btn-warning">Edit</a>
                                        <a href="{% url 'note_delete' note.pk %}" class="btn btn-sm btn-danger">Delete</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No notes yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Action Items Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Action Items</h4>
            </div>
            <div class="card-body">
                {% if action_items %}
                    <ul class="list-group">
                        {% for ai in action_items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ ai.title }}</strong>
                                    <div>{{ ai.description }}</div>
                                    <small class="text-muted">Assigned to:
                                        {% if ai.assigned_to %}
                                            {{ ai.assigned_to.username }}
                                        {% else %}
                                            Unassigned
                                        {% endif %}
                                    </small>
                                </div>
                                {% if ai.completed %}
                                    <span class="badge bg-success">Done</span>
                                {% else %}
                                    <span class="badge bg-secondary">Open</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No action items.</p>
                {% endif %}
            </div>
        </div>

        <!-- Attachments Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Attachments</h4>
            </div>
            <div class="card-body">
                {% if attachments %}
                    <ul class="list-group">
                        {% for att in attachments %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ att.name }}</strong>
                                    <div><a href="{{ att.file_url }}" target="_blank">Open</a></div>
                                    <small class="text-muted">Uploaded by:
                                        {% if att.uploaded_by %}
                                            {{ att.uploaded_by.username }}
                                        {% else %}
                                            Unknown
                                        {% endif %}
                                    </small>
                                </div>
                                <small class="text-muted">{{ att.created_at|date:"F d, Y H:i" }}</small>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No attachments.</p>
                {% endif %}
            </div>
        </div>

    </div>

    <div class="col-md-4">
        <!-- Attendees Sidebar -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Attendees</h5>
            </div>
            <div class="card-body">
                {% if attendees %}
                    <ul class="list-group list-group-flush">
                        {% for attendee in attendees %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span>{{ attendee.user.username }}</span>
                                    <small class="text-muted d-block">{{ attendee.get_status_display }}</small>
                                </div>
                                <div>
                                    {% if attendee.user == user %}
                                        {% if attendee.status != 'accepted' %}
                                            <form method="post" action="{% url 'attendee_update_status' attendee.pk %}" class="d-inline">
                                                {% csrf_token %}
                                                <input type="hidden" name="status" value="accepted">
                                                <button type="submit" class="btn btn-sm btn-success">Accept</button>
                                            </form>
                                        {% endif %}
                                        {% if attendee.status != 'declined' %}
                                            <form method="post" action="{% url 'attendee_update_status' attendee.pk %}" class="d-inline">
                                                {% csrf_token %}
                                                <input type="hidden" name="status" value="declined">
                                                <button type="submit" class="btn btn-sm btn-danger">Decline</button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No attendees yet.</p>
                {% endif %}
            </div>
            <div class="card-footer">
                <a href="{% url 'attendee_add' meeting.pk %}" class="btn btn-sm btn-primary">Add Attendee</a>
            </div>
        </div>
    </div>

</div>

{% endblock %}
    

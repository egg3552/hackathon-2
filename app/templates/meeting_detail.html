{% extends "base.html" %}

{% block title %}Meeting Details - Meeting Notes App{% endblock %}

{% block content %}
<div class="row" id="meetingDetailPage" data-meeting-id="{{ meeting_id }}">
    <div class="col-12">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary mb-3">
            <i class="bi bi-arrow-left"></i> Back to Meetings
        </a>
        
        <!-- Meeting Header -->
        <div id="meetingHeader" class="card mb-4">
            <div class="card-body">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Notes Section -->
            <div class="col-md-7">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-journal-text"></i> Notes</h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createNoteModal">
                            <i class="bi bi-plus-circle"></i> Add Note
                        </button>
                    </div>
                    <div class="card-body" id="notesList">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendees Section -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Attendees</h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createAttendeeModal">
                            <i class="bi bi-person-plus"></i> Add
                        </button>
                    </div>
                    <div class="card-body" id="attendeesList">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Note Modal -->
<div class="modal fade" id="createNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createNoteForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="noteContent" class="form-label">Content (Markdown supported)</label>
                        <textarea class="form-control" id="noteContent" rows="10" required></textarea>
                        <small class="text-muted">You can use Markdown formatting</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editNoteForm">
                <input type="hidden" id="editNoteId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editNoteContent" class="form-label">Content (Markdown supported)</label>
                        <textarea class="form-control" id="editNoteContent" rows="10" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Attendee Modal -->
<div class="modal fade" id="createAttendeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Attendee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createAttendeeForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="attendeeName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="attendeeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="attendeeEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="attendeeEmail" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Attendee</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Get meeting ID from data attribute
    const meetingId = parseInt(
        document.getElementById('meetingDetailPage').dataset.meetingId
    );

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadMeetingDetails();
        loadNotes();
        loadAttendees();
    });

    // Load meeting details
    async function loadMeetingDetails() {
        try {
            const response = await fetch(`/api/meetings/${meetingId}`);
            const meeting = await response.json();
            
            document.getElementById('meetingHeader').innerHTML = `
                <div class="card-body">
                    <h2 class="card-title">${meeting.title}</h2>
                    <p class="card-text">${meeting.description || 'No description'}</p>
                    <p class="mb-0">
                        <i class="bi bi-calendar3"></i> ${formatDate(meeting.date)}
                        ${meeting.location ? `<br><i class="bi bi-geo-alt"></i> ${meeting.location}` : ''}
                    </p>
                </div>
            `;
        } catch (error) {
            showFlashMessage('Failed to load meeting details', 'danger');
        }
    }

    // Load notes
    async function loadNotes() {
        try {
            const response = await fetch(`/api/notes?meeting_id=${meetingId}`);
            const data = await response.json();
            
            displayNotes(data.notes);
        } catch (error) {
            showFlashMessage('Failed to load notes', 'danger');
        }
    }

    // Display notes
    function displayNotes(notes) {
        const container = document.getElementById('notesList');
        
        if (notes.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No notes yet. Add your first note!</p>';
            return;
        }
        
        container.innerHTML = notes.map(note => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="markdown-content">${marked.parse(note.content)}</div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> ${formatDate(note.created_at)}
                        </small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editNote(${note.id}, \`${escapeHtml(note.content)}\`)">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteNote(${note.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Load attendees
    async function loadAttendees() {
        try {
            const response = await fetch(`/api/attendees?meeting_id=${meetingId}`);
            const data = await response.json();
            
            displayAttendees(data.attendees);
        } catch (error) {
            showFlashMessage('Failed to load attendees', 'danger');
        }
    }

    // Display attendees
    function displayAttendees(attendees) {
        const container = document.getElementById('attendeesList');
        
        if (attendees.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No attendees yet.</p>';
            return;
        }
        
        container.innerHTML = `
            <ul class="list-group list-group-flush">
                ${attendees.map(attendee => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${attendee.name}</strong><br>
                            <small class="text-muted">${attendee.email}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendee(${attendee.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </li>
                `).join('')}
            </ul>
        `;
    }

    // Create note form handler
    document.getElementById('createNoteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const noteData = {
            meeting_id: meetingId,
            content: document.getElementById('noteContent').value
        };
        
        try {
            const response = await fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(noteData)
            });
            
            if (response.ok) {
                showFlashMessage('Note added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('createNoteModal')).hide();
                document.getElementById('createNoteForm').reset();
                loadNotes();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to add note', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    });

    // Edit note
    function editNote(id, content) {
        document.getElementById('editNoteId').value = id;
        document.getElementById('editNoteContent').value = content;
        new bootstrap.Modal(document.getElementById('editNoteModal')).show();
    }

    // Edit note form handler
    document.getElementById('editNoteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('editNoteId').value;
        const noteData = {
            content: document.getElementById('editNoteContent').value
        };
        
        try {
            const response = await fetch(`/api/notes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(noteData)
            });
            
            if (response.ok) {
                showFlashMessage('Note updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editNoteModal')).hide();
                loadNotes();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to update note', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    });

    // Delete note
    async function deleteNote(id) {
        if (!confirm('Are you sure you want to delete this note?')) return;
        
        try {
            const response = await fetch(`/api/notes/${id}`, { method: 'DELETE' });
            
            if (response.ok) {
                showFlashMessage('Note deleted successfully!', 'success');
                loadNotes();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to delete note', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    }

    // Create attendee form handler
    document.getElementById('createAttendeeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const attendeeData = {
            meeting_id: meetingId,
            name: document.getElementById('attendeeName').value,
            email: document.getElementById('attendeeEmail').value
        };
        
        try {
            const response = await fetch('/api/attendees', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attendeeData)
            });
            
            if (response.ok) {
                showFlashMessage('Attendee added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('createAttendeeModal')).hide();
                document.getElementById('createAttendeeForm').reset();
                loadAttendees();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to add attendee', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    });

    // Delete attendee
    async function deleteAttendee(id) {
        if (!confirm('Are you sure you want to remove this attendee?')) return;
        
        try {
            const response = await fetch(`/api/attendees/${id}`, { method: 'DELETE' });
            
            if (response.ok) {
                showFlashMessage('Attendee removed successfully!', 'success');
                loadAttendees();
            } else {
                const data = await response.json();
                showFlashMessage(data.error || 'Failed to remove attendee', 'danger');
            }
        } catch (error) {
            showFlashMessage('An error occurred', 'danger');
        }
    }

    // Helper functions
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        return text.replace(/`/g, '\\`').replace(/\$/g, '\\$');
    }
</script>
{% endblock %}
